name: Deploy to EC2 (Live Reload Guaranteed)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy & Hard Restart
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
        EC2_KEY: ${{ secrets.EC2_SSH_KEY }}
      run: |
        echo "$EC2_KEY" > key.pem
        chmod 400 key.pem

        # 1. Fully replace code on server
        rsync -avz --delete \
          -e "ssh -i key.pem -o StrictHostKeyChecking=no" \
          --exclude='.git*' --exclude='key.pem' \
          ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/fastapi-app/

        # 2. Kill everything old + start fresh
        ssh -i key.pem -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          cd /home/ubuntu/fastapi-app

          # Brutal kill of any old process
          pkill -9 -f gunicorn || true
          pkill -9 -f uvicorn || true
          pkill -9 -f "python.*main:app" || true
          sleep 2

          # Fresh install + start
          pip3 install --user -r requirements.txt -q
          nohup gunicorn main:app \
            --config gunicorn.conf.py \
            --daemon > logs/output.log 2>&1 &

          echo "New code fully deployed and running!"
        EOF

        rm -f key.pem